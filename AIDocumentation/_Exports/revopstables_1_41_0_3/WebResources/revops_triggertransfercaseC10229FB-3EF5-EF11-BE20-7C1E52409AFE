function triggerTransferCase(primaryControl) {
    console.log("Starting triggerTransferCase function");
    
    // Get case
    var caseId;
    var caseName = "";
    var formContext;
    
    try {
        // Use Xrm.Page to get case ID
        if (Xrm && Xrm.Page && Xrm.Page.data && Xrm.Page.data.entity) {
            caseId = Xrm.Page.data.entity.getId().replace(/[{}]/g, "");
            if (Xrm.Page.getAttribute("title")) {
                caseName = Xrm.Page.getAttribute("title").getValue() || "";
            }
            formContext = Xrm.Page;
            
            console.log("Retrieved case ID:", caseId);
            console.log("Case name:", caseName);
        } else {
            throw new Error("Could not retrieve case ID.");
        }
    } catch (e) {
        console.error("Error retrieving case details:", e);
        var alertStrings = { 
            confirmButtonLabel: "OK", 
            text: "Unable to get Case ID. Please open a RevOps ticket." 
        };
        var alertOptions = { height: 120, width: 260 };
        Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
        return;
    }
    
    // Filter queues using FetchXML filter snippet (filterXML)
    var lookupOptions = {
        allowMultiSelect: false,
        defaultEntityType: "queue",
        entityTypes: ["queue"],
        disableMru: true,
        filters: [
            {
                entityLogicalName: "queue",
                filterXml: "<filter type='or'><condition attribute='name' operator='eq' value='Billing' /><condition attribute='name' operator='eq' value='Cloud Solutions Team' /><condition attribute='name' operator='eq' value='Level 2' /></filter>"
            }
        ]
    };
    
    console.log("Opening filtered queue lookup");
    
    // Open the lookup dialog to select a queue
    Xrm.Utility.lookupObjects(lookupOptions).then(
        function(result) {
            if (result && result.length > 0) {
                var selectedQueue = result[0];
                console.log("Selected Queue:", selectedQueue);
                
                // Get queue info
                var queueId = selectedQueue.id.replace(/[{}]/g, "");
                var queueName = selectedQueue.name;
                
                // Get user for ownership
                console.log("Looking up service user");
                var userReq = new XMLHttpRequest();
                var userUrl = Xrm.Utility.getGlobalContext().getClientUrl() + 
                    "/api/data/v9.1/systemusers?$select=systemuserid,fullname&$filter=contains(fullname,'ISC-DYN-10001-SVC-Dynamics365ObjectsOwner')";
                
                userReq.open("GET", userUrl, true);
                userReq.setRequestHeader("OData-MaxVersion", "4.0");
                userReq.setRequestHeader("OData-Version", "4.0");
                userReq.setRequestHeader("Accept", "application/json");
                
                userReq.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        if (this.status === 200) {
                            var userResults = JSON.parse(this.response);
                            
                            if (userResults.value && userResults.value.length > 0) {
                                var user = userResults.value[0];
                                console.log("Found user:", user);
                                
                                // If Billing queue is selected, get Subject with title "Billing"
                                if (queueName === "Billing") {
                                    console.log("Billing queue selected, looking up Billing subject");
                                    
                                    var subjectReq = new XMLHttpRequest();
                                    var subjectUrl = Xrm.Utility.getGlobalContext().getClientUrl() + 
                                        "/api/data/v9.1/subjects?$select=subjectid&$filter=title eq 'Billing'";
                                    
                                    subjectReq.open("GET", subjectUrl, true);
                                    subjectReq.setRequestHeader("OData-MaxVersion", "4.0");
                                    subjectReq.setRequestHeader("OData-Version", "4.0");
                                    subjectReq.setRequestHeader("Accept", "application/json");
                                    
                                    subjectReq.onreadystatechange = function() {
                                        if (this.readyState === 4) {
                                            if (this.status === 200) {
                                                var subjectResults = JSON.parse(this.response);
                                                
                                                if (subjectResults.value && subjectResults.value.length > 0) {
                                                    var subject = subjectResults.value[0];
                                                    console.log("Found subject:", subject);
                                                    
                                                    // Proceed with case update including subject
                                                    updateCaseWithSubject(caseId, queueId, queueName, user.systemuserid, subject.subjectid);
                                                } else {
                                                    console.error("Billing subject not found");
                                                    var alertStrings = { 
                                                        confirmButtonLabel: "OK", 
                                                        text: "Could not find the Subject with title 'Billing'" 
                                                    };
                                                    var alertOptions = { height: 120, width: 260 };
                                                    Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
                                                }
                                            } else {
                                                console.error("Error looking up subject: Status " + this.status);
                                                var alertStrings = { 
                                                    confirmButtonLabel: "OK", 
                                                    text: "Error looking up Subject. Status: " + this.status 
                                                };
                                                var alertOptions = { height: 120, width: 260 };
                                                Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
                                            }
                                        }
                                    };
                                    
                                    subjectReq.send();
                                } else {
                                    // Not Billing queue, proceed without subject
                                    updateCaseWithSubject(caseId, queueId, queueName, user.systemuserid, null);
                                }
                                
                            } else {
                                var alertStrings = { 
                                    confirmButtonLabel: "OK", 
                                    text: "Could not find the service user (ISC-DYN-10001-SVC-Dynamics365ObjectsOwner)" 
                                };
                                var alertOptions = { height: 120, width: 260 };
                                Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
                            }
                        } else {
                            console.error("Error looking up user: Status " + this.status);
                            var alertStrings = { 
                                confirmButtonLabel: "OK", 
                                text: "Error looking up user. Status: " + this.status 
                            };
                            var alertOptions = { height: 120, width: 260 };
                            Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
                        }
                    }
                };
                
                userReq.send();
                
            } else {
                console.log("No queue was selected");
            }
        },
        function(error) {
            console.error("Error in queue lookup:", error);
            var alertStrings = {
                confirmButtonLabel: "OK",
                text: "Error selecting queue: " + (error.message || "Unknown error")
            };
            var alertOptions = { height: 120, width: 260 };
            Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
        }
    );
    
    // Function to update case with or without subject
    function updateCaseWithSubject(caseId, queueId, queueName, userId, subjectId) {
        // Prepare update
        var entity = {};
        
        // Changes for case
        entity["revops_queue@odata.bind"] = "/queues(" + queueId + ")";
        entity.statecode = 0;    // Active
        entity.statuscode = 1;   // New
        entity["ownerid@odata.bind"] = "/systemusers(" + userId + ")";
        
        // Add subject binding if provided
        if (subjectId) {
            entity["subjectid@odata.bind"] = "/subjects(" + subjectId + ")";
            console.log("Updating case with subject");
        } else {
            console.log("Updating case without subject");
        }
        
        // Create request to update the case
        var updateReq = new XMLHttpRequest();
        updateReq.open("PATCH", Xrm.Utility.getGlobalContext().getClientUrl() + 
            "/api/data/v9.1/incidents(" + encodeURIComponent(caseId) + ")", true);
        updateReq.setRequestHeader("OData-MaxVersion", "4.0");
        updateReq.setRequestHeader("OData-Version", "4.0");
        updateReq.setRequestHeader("Accept", "application/json");
        updateReq.setRequestHeader("Content-Type", "application/json; charset=utf-8");
        
        updateReq.onreadystatechange = function() {
            if (this.readyState === 4) {
                updateReq.onreadystatechange = null;
                if (this.status === 204) {
                    console.log("Case updated successfully");
                    
                    // Prepare note text
                    var noteText = `Case transferred to ${queueName} queue. Owner changed to ISC-DYN-10001-SVC-Dynamics365ObjectsOwner; Status changed to New.`;
                    
                    // Add subject info to note if applicable
                    if (subjectId) {
                        noteText += " Subject set to 'Billing'.";
                    }
                    
                    // Add note
                    var annotation = {
                        "objectid_incident@odata.bind": "/incidents(" + caseId + ")",
                        "objecttypecode": "incident",
                        "subject": "System Update",
                        "notetext": noteText
                    };
                    
                    var noteReq = new XMLHttpRequest();
                    noteReq.open("POST", Xrm.Utility.getGlobalContext().getClientUrl() + 
                        "/api/data/v9.1/annotations", true);
                    noteReq.setRequestHeader("OData-MaxVersion", "4.0");
                    noteReq.setRequestHeader("OData-Version", "4.0");
                    noteReq.setRequestHeader("Accept", "application/json");
                    noteReq.setRequestHeader("Content-Type", "application/json; charset=utf-8");
                    
                    noteReq.onreadystatechange = function() {
                        if (this.readyState === 4) {
                            // Regardless of the result, show the success message
                            var alertStrings = { 
                                confirmButtonLabel: "OK", 
                                text: "Case was transferred successfully to " + queueName 
                            };
                            var alertOptions = { height: 120, width: 260 };
                            Xrm.Navigation.openAlertDialog(alertStrings, alertOptions).then(
                                function() {
                                    // Refresh form
                                    try {
                                        if (formContext && formContext.data) {
                                            formContext.data.refresh(true);
                                            
                                            // Refresh timeline after delay
                                            setTimeout(() => {
                                                try {
                                                    var controls = formContext.ui.controls.get();
                                                    for (var i = 0; i < controls.length; i++) {
                                                        var control = controls[i];
                                                        if (control.getControlType() === "timelinewall") {
                                                            control.refresh();
                                                            console.log("Timeline refreshed");
                                                            break;
                                                        }
                                                    }
                                                } catch (error) {
                                                    console.error("Error refreshing timeline:", error);
                                                }
                                            }, 500);
                                        }
                                    } catch (e) {
                                        console.error("Error refreshing form:", e);
                                    }
                                }
                            );
                        }
                    };
                    
                    noteReq.send(JSON.stringify(annotation));
                    
                } else {
                    try {
                        var error = JSON.parse(this.response).error;
                        console.log("Error updating case: " + error.message);
                        var alertStrings = { 
                            confirmButtonLabel: "OK", 
                            text: "Error updating case: " + error.message 
                        };
                        var alertOptions = { height: 120, width: 260 };
                        Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
                    } catch (e) {
                        console.error("Error parsing update response:", e);
                        var alertStrings = { 
                            confirmButtonLabel: "OK", 
                            text: "Error updating case. Status code: " + this.status 
                        };
                        var alertOptions = { height: 120, width: 260 };
                        Xrm.Navigation.openAlertDialog(alertStrings, alertOptions);
                    }
                }
            }
        };
        
        updateReq.send(JSON.stringify(entity));
    }
}