function setEmailSubject(executionContext) {
    var formContext = executionContext.getFormContext();

    setTimeout(function () {
        // Only do this for NEW emails (Create / Quick Create)
        var formType = formContext.ui.getFormType();
        // 1 = Create, 5 = Quick Create
        if (formType !== 1 && formType !== 5) {
            console.log("setEmailSubject: Existing email. Leaving subject as-is.");
            return;
        }

        var regardingObject = formContext.getAttribute("regardingobjectid");
        if (!regardingObject || regardingObject.getValue() == null) {
            console.log("setEmailSubject: No regarding object set.");
            return;
        }

        var regarding = regardingObject.getValue()[0];
        if (regarding.entityType !== "incident") {
            console.log("setEmailSubject: Regarding is not a Case. Skipping.");
            return;
        }

        var subjectField = formContext.getAttribute("subject");
        if (!subjectField) {
            console.log("setEmailSubject: Subject field not found.");
            return;
        }

        // If subject already has a value (user typed something), don't override
        var currentSubject = subjectField.getValue();
        if (currentSubject && currentSubject.trim() !== "") {
            console.log("setEmailSubject: Subject already has a value. Skipping.");
            return;
        }

        var caseId = regarding.id.replace(/[{}]/g, "");

        Xrm.WebApi.retrieveRecord("incident", caseId, "?$select=title,ticketnumber").then(
            function success(result) {
                var newSubject = "[" + result.ticketnumber + "] " + result.title;

                // Only set if different / empty to avoid marking as dirty unnecessarily
                if (!currentSubject || currentSubject !== newSubject) {
                    subjectField.setValue(newSubject);
                    console.log("setEmailSubject: Subject set to '" + newSubject + "'.");
                }
            },
            function (error) {
                console.error("setEmailSubject: Error retrieving case: ", error.message);
            }
        );
    }, 500);
}
