<style>
  /* Hidden field styling for Power Pages td.clearfix structure */
  td.clearfix.field-hidden {
    display: none !important;
  }
</style>

<div class="row sectionBlockLayout text-start" style="display: flex; flex-wrap: wrap; margin: 0px; min-height: auto; padding: 8px;">
  <div class="container" style="display: flex; flex-wrap: wrap;"><div class="col-lg-12 columnBlockLayout" style="flex-grow: 1; display: flex; flex-direction: column; min-width: 250px; padding: 16px; margin: 60px 0px;">{% entityform name: 'License Adjustment Details' %}</div></div>
</div>

<script>
(function() {
    'use strict';
    
    // Wait for jQuery to be available
    function waitForJQuery(callback) {
        if (typeof jQuery !== 'undefined') {
            callback();
        } else {
            setTimeout(function() { waitForJQuery(callback); }, 100);
        }
    }
    
    // Wait for form fields to be fully loaded
    function waitForFormFields(callback, maxAttempts = 150) {
        let attempts = 0;
        const interval = setInterval(function() {
            attempts++;
            
            // Check if at least one of the key fields exists
            const $licenseNameField = $('#revops_licensename, [name*="revops_licensename"]');
            const $modificationTypeField = $('#revops_modificationtype, [name*="revops_modificationtype"]');
            
            if ($licenseNameField.length > 0 || $modificationTypeField.length > 0) {
                clearInterval(interval);
                callback();
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                return;
            }
        }, 200);
    }
    
    waitForJQuery(function() {
        waitForFormFields(function() {
                       
            // ============================================
            // HELPER FUNCTIONS
            // ============================================
            
            // Add helper text with aria-describedby (for future use)
            function addHelperText(fieldName, helperText) {
                const selectors = [
                    `#${fieldName}`,
                    `[data-attribute="${fieldName}"]`,
                    `[name*="${fieldName}"]`
                ];
                
                for (let selector of selectors) {
                    const $field = $(selector);
                    if ($field.length > 0) {
                        // Remove existing helper text if any
                        $field.closest('td.clearfix').find('.field-helper-text').remove();
                        
                        // Add new helper text with unique ID for aria-describedby
                        const helperId = `${fieldName}-helper`;
                        const $helperDiv = $('<div class="field-helper-text" style="font-size: 0.875rem; color: #6c757d; margin-top: 0.25rem; margin-bottom: 0.5rem;"></div>');
                        $helperDiv.attr('id', helperId);
                        $helperDiv.html(helperText);
                        
                        // Insert before the field
                        $field.before($helperDiv);
                        
                        // Associate helper text with field for screen readers
                        $field.attr('aria-describedby', helperId);
                        
                        return true;
                    }
                }
                return false;
            }
            
            // Enhance required fields with ARIA attributes (if not already present)
            function enhanceRequiredFields() {
                const requiredFields = [
                    'revops_licensename',
                    'revops_modificationtype',
                    'revops_quantityoflicensestomodify',
                    'revops_subscriptionterm'
                ];
                
                requiredFields.forEach(function(fieldName) {
                    const selectors = [
                        `#${fieldName}`,
                        `[data-attribute="${fieldName}"]`,
                        `[name*="${fieldName}"]`
                    ];
                    
                    for (let selector of selectors) {
                        const $field = $(selector);
                        if ($field.length > 0) {
                            // Only add aria-required if Power Pages hasn't already added it
                            if (!$field.attr('aria-required')) {
                                $field.attr('aria-required', 'true');
                            }
                            
                            // DO NOT add asterisks - Power Pages Basic Form Metadata already handles this
                            break;
                        }
                    }
                });
            }
            
            // Monitor form validation and add aria-invalid to error fields
            function monitorValidation() {
                // Watch for Power Pages validation errors
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' || mutation.type === 'childList') {
                            // Look for validation error indicators
                            $('.field-validation-error, .error, [class*="invalid"]').each(function() {
                                const $errorElement = $(this);
                                const $container = $errorElement.closest('td.clearfix');
                                const $field = $container.find('input, select, textarea').first();
                                
                                if ($field.length > 0 && !$field.attr('aria-invalid')) {
                                    $field.attr('aria-invalid', 'true');
                                }
                            });
                            
                            // Remove aria-invalid from fields that are now valid
                            $('input[aria-invalid], select[aria-invalid], textarea[aria-invalid]').each(function() {
                                const $field = $(this);
                                const $container = $field.closest('td.clearfix');
                                const hasError = $container.find('.field-validation-error, .error, [class*="invalid"]').length > 0;
                                
                                if (!hasError) {
                                    $field.removeAttr('aria-invalid');
                                }
                            });
                        }
                    });
                });
                
                // Observe the form container for changes
                const $formContainer = $('.entity-form, form').first();
                if ($formContainer.length > 0) {
                    observer.observe($formContainer[0], {
                        attributes: true,
                        childList: true,
                        subtree: true,
                        attributeFilter: ['class', 'style']
                    });
                }
            }
            
            // ============================================
            // INITIALIZE
            // ============================================
            
            enhanceRequiredFields();
            monitorValidation();
            
        }); // End waitForFormFields
    }); // End waitForJQuery
    
})();
</script>