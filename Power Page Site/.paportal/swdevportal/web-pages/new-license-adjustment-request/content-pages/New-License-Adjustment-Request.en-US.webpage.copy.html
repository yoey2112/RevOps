{% fetchxml queueQuery %}
<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
    <entity name="queue">
        <attribute name="queueid" />
        <attribute name="name" />
        <filter type="and">
            <condition attribute="name" operator="eq" value="Cloud Solutions Team" />
            <condition attribute="statecode" operator="eq" value="0" />
        </filter>
    </entity>
</fetch>
{% endfetchxml %}

{% assign queue = queueQuery.results.entities[0] %}
{% if queue %}
{% assign queueId = queue.queueid %}
{% assign queueName = queue.name %}
{% endif %}

<!-- Store queue ID for auto-population -->
<script>
    window.LICENSE_ADJUSTMENT_QUEUE_ID = "{{ queueId }}";
    window.LICENSE_ADJUSTMENT_QUEUE_NAME = "{{ queueName }}";
</script>

<style>
  /* Hidden field styling for Power Pages td.clearfix structure */
  td.clearfix.field-hidden {
    display: none !important;
  }
</style>

<div class="row sectionBlockLayout text-start" style="display: flex; flex-wrap: wrap; margin: 0px; min-height: auto; padding: 8px;">
  <div class="container" style="display: flex; flex-wrap: wrap;"><div class="col-lg-12 columnBlockLayout" style="flex-grow: 1; display: flex; flex-direction: column; min-width: 250px; padding: 16px; margin: 60px 0px;">{% entityform name: 'Create Case - License Adjustment' %}</div></div>
</div>

<script>
    (function () {
        'use strict';

        const queueId = window.LICENSE_ADJUSTMENT_QUEUE_ID;
        const queueName = window.LICENSE_ADJUSTMENT_QUEUE_NAME;

        if (!queueId) {
            console.error('License Adjustment: Queue not found');
            return;
        }

        // Function to set lookup field value
        function setLookupField(fieldId, entityName, recordId, recordName) {
            const field = $(`#${fieldId}`);

            if (field.length && recordId) {
                // Check if it's a SELECT dropdown
                if (field.prop('tagName') === 'SELECT') {
                    field.val(recordId);
                    field.trigger('change');
                } else {
                    // For lookup/entity reference fields
                    field.val(recordId);
                    field.attr('value', recordId);

                    // Set related hidden fields for entity reference
                    const entityNameField = $(`#${fieldId}_entityname`);
                    const nameField = $(`#${fieldId}_name`);

                    if (entityNameField.length) {
                        entityNameField.val(entityName);
                        entityNameField.attr('value', entityName);
                    }

                    if (nameField.length) {
                        nameField.val(recordName);
                        nameField.attr('value', recordName);
                    }

                    field.trigger('change');
                }
                return true;
            } else {
                console.error('License Adjustment: Failed to set queue field');
                return false;
            }
        }

        // Wait for the queue field to be available before setting it
        function waitForField(selector, callback, maxAttempts = 50) {
            let attempts = 0;
            const interval = setInterval(function() {
                attempts++;
                const $field = $(selector);
                
                if ($field.length > 0) {
                    clearInterval(interval);
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    console.error('License Adjustment: Queue field not found after ' + (maxAttempts * 100) + 'ms');
                }
            }, 100);
        }

        function setQueueField() {
            setLookupField('revops_queue', 'queue', queueId, queueName);
        }

        // Wait for queue field to be available, then set it
        waitForField('#revops_queue', setQueueField);

    })();
</script>