{% assign input_category = input_category | default: '' %}

{%- comment -%}
BASELINE VERSION with Performance Monitoring
This is the ORIGINAL code from KBCategoryWidget_202510101036.html
with performance monitoring tools added for baseline testing.
NO OPTIMIZATIONS - Use this to establish baseline metrics.
{%- endcomment -%}

{% fetchxml articlesQuery %}
<fetch aggregate="true" returntotalrecordcount="true">
    <entity name="knowledgearticle">
        <attribute name="knowledgearticleid" alias="knowledgearticleid" groupby="true" />
        <attribute name="title" alias="title" groupby="true" />
        <attribute name="statecode" alias="statecode" groupby="true" />
        <attribute name="statuscode" alias="statuscode" groupby="true" />
        <attribute name="revops_category" alias="categoryid" groupby="true" />
        <attribute name="articlepublicnumber" alias="articlepublicnumber" groupby="true" />
        <filter type="and">
            <condition attribute="statecode" operator="eq" value="3" />
            <condition attribute="isrootarticle" operator="eq" value="0" />
            <condition attribute="isinternal" operator="eq" value="0" />
            <condition attribute="languagelocaleid" operator="eq" value="{56940b3e-300f-4070-a559-5a6a4d11a8a3}" uiname="English - United States" uitype="languagelocale" />
        </filter>
        <order alias="title" />
        <link-entity name="category" alias="aa" link-type="inner" from="categoryid" to="revops_category">
            <attribute name="title" alias="category" groupby="true" />
            <filter type="and">
                <condition attribute="title" operator="not-null" />
            </filter>
        </link-entity>
    </entity>
</fetch>
{% endfetchxml %}

{% fetchxml categoriesQuery %}
<fetch aggregate="true">
    <entity name="category">
        <attribute name="title" alias="title" groupby="true" />
        <attribute name="categoryid" alias="categoryid" groupby="true" />
        <attribute name="categorynumber" alias="categorynumber" groupby="true" />
        <attribute name="parentcategoryid" alias="parentcategoryid" groupby="true" />
        <attribute name="revops_istoplevelcategory" alias="istoplevelcategory" groupby="true" />
        <attribute name="revops_isinternal" alias="isinternal" groupby="true" />
        <filter type="and">
            <condition attribute="title" operator="not-null" />
        </filter>
        <order alias="title" />
        <link-entity name="category" alias="parent" link-type="outer" from="categoryid" to="parentcategoryid">
            <attribute name="title" alias="parenttitle" groupby="true" />
            <attribute name="categoryid" alias="parentcategoryid_value" groupby="true" />
        </link-entity>
    </entity>
</fetch>
{% endfetchxml %}

{% assign categories = categoriesQuery.results.entities | where: "isinternal", false %}
{% assign articles = articlesQuery.results.entities %}
{% assign top_level_categories = categories | where: "istoplevelcategory", true %}

<!-- Performance Dashboard Styles -->
<style>
#kb-perf-dashboard {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: rgba(0, 0, 0, 0.95);
  color: #fff;
  padding: 15px 20px;
  border-radius: 10px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  z-index: 999999;
  min-width: 320px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  display: none;
  border: 1px solid rgba(255, 255, 255, 0.1);
}
#kb-perf-dashboard h4 {
  margin: 0 0 12px 0;
  font-size: 14px;
  font-weight: bold;
  color: #4CAF50;
  border-bottom: 2px solid #333;
  padding-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#kb-perf-dashboard .metric {
  display: flex;
  justify-content: space-between;
  margin: 6px 0;
  padding: 5px 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}
#kb-perf-dashboard .metric-name {
  color: #bbb;
  font-size: 11px;
}
#kb-perf-dashboard .metric-value {
  font-weight: bold;
  font-size: 13px;
}
#kb-perf-dashboard .metric-value.excellent { color: #4CAF50; }
#kb-perf-dashboard .metric-value.good { color: #8BC34A; }
#kb-perf-dashboard .metric-value.ok { color: #FF9800; }
#kb-perf-dashboard .metric-value.poor { color: #f44336; }
#kb-perf-dashboard .close-btn {
  cursor: pointer;
  font-size: 20px;
  color: #999;
  line-height: 1;
  padding: 0 5px;
  transition: color 0.2s;
}
#kb-perf-dashboard .close-btn:hover {
  color: #fff;
}
#kb-perf-dashboard .summary {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid #333;
  text-align: center;
  font-size: 14px;
  font-weight: bold;
}
#kb-perf-dashboard .version {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid #333;
  text-align: center;
  font-size: 10px;
  color: #666;
}
#kb-perf-dashboard .actions {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #333;
  display: flex;
  gap: 8px;
}
#kb-perf-dashboard button {
  flex: 1;
  padding: 6px 10px;
  background: #333;
  border: 1px solid #555;
  color: #fff;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
  transition: background 0.2s;
}
#kb-perf-dashboard button:hover {
  background: #444;
}
#kb-perf-toggle {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 999998;
  transition: transform 0.2s;
}
#kb-perf-toggle:hover {
  transform: scale(1.1);
}
</style>

<!-- Performance Dashboard HTML -->
<button id="kb-perf-toggle" title="Show Performance Metrics">âš¡</button>
<div id="kb-perf-dashboard">
  <h4>
    <span>âš¡ Performance Metrics</span>
    <span class="close-btn" id="kb-perf-close">Ã—</span>
  </h4>
  <div id="kb-perf-metrics"></div>
  <div class="summary" id="kb-perf-summary"></div>
  <div class="version">BASELINE - Original Code</div>
  <div class="actions">
    <button id="kb-perf-export">ðŸ“‹ Copy JSON</button>
    <button id="kb-perf-reload">ðŸ”„ Retest</button>
  </div>
</div>

<div class="category-container container">
  {% if input_category != '' %}
    {% assign subcategories = categories | where: "parenttitle", input_category %}
    <div class="row pb-1">
      <div class="col-lg-12">
        <h2 class="mb-4">{{ input_category }}</h2>
      </div>
    </div>
    {% if subcategories.size > 0 %}
      <div class="row justify-content-between">
        {% for category in subcategories %}
          {% assign category_articles = articles | where: "category", category.title %}
          {% if category_articles.size > 0 %}
            <div class="col-12 col-md-6">
              <div class="category-block">
                <h4 class="fw-normal pb-0 d-flex align-items-center">
                  {{ category.title }}
                  <span class="badge rounded-pill bg-danger ms-2">{{ category_articles.size }}</span>
                </h4>
                <ul class="list-group list-group-flush">
                  {% for article in category_articles limit:5 %}
                    <li class="list-group-item">
                      <a href="{{ article.url | escape }}" class="d-flex gap-3 align-items-center">
                        <i class="fa-light fa-file"></i><span>{{ article.title }}</span>
                      </a>
                    </li>
                  {% endfor %}
                </ul>
                <a href="{{ sitemarkers['Category'].url | add_query: 'id', category.categorynumber }}" class="btn btn-outline-secondary btn-sm">
                  See all articles
                </a>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      <p class="empty-message">No subcategories found for {{ input_category }}.</p>
    {% endif %}
  {% else %}
    {% for top_category in top_level_categories %}
      <div class="row pb-1 pt-4">
        <h2 class="mb-3">{{ top_category.title }}</h2>
      </div>
      {% assign has_articles_in_subcategories = false %}
      <div class="row justify-content-between">
        {% assign processed_categories = "" | split: "," %}
        {% for category in categories %}
          {% assign category_id_str = category.categoryid | downcase %}
          {% if processed_categories contains category_id_str %}
            {% continue %}
          {% endif %}
          {% if category.parenttitle == top_category.title %}
            {% assign processed_categories = processed_categories | push: category_id_str %}
            {% assign category_url = sitemarkers['Category'].url %}
            {% assign category_articles = articles | where: "category", category.title %}
            {% if category_articles.size > 0 %}
              {% assign has_articles_in_subcategories = true %}
              <div class="col-12 col-md-5">
                <div class="position-relative d-flex align-items-center gap-4">
                  <a href="{{ category_url | add_query: 'id', category.categorynumber }}">
                    <h3 class="fw-normal mt-0 pt-0 pb-0">{{ category.title }}</h3>
                  </a>
                  <span class="translate-middle badge rounded-pill bg-danger">
                    {{ category_articles.size }}
                    <span class="visually-hidden">articles</span>
                  </span>
                </div>
                <ul class="list-group list-group-flush">
                  {% for article in category_articles limit:5 %}
                    <li class="list-group-item">
                      <a href="{{ article.url | escape }}" class="d-flex gap-3 align-items-center">
                        <i class="fa-light fa-file"></i><span>{{ article.title }}</span>
                      </a>
                    </li>
                  {% endfor %}
                </ul>
                <a href="{{ category_url | add_query: 'id', category.categorynumber }}" role="button" class="btn btn-outline-secondary mb-5">See all articles</a>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
      {% unless has_articles_in_subcategories %}
        <p class="empty-message">No articles found in subcategories</p>
      {% endunless %}
    {% endfor %}
  {% endif %}
</div>

<!-- Performance Monitoring Script -->
<script>
(function() {
  'use strict';
  
  var PerfMonitor = {
    version: 'BASELINE',
    currentTest: null,
    tests: JSON.parse(localStorage.getItem('kb-perf-tests-baseline') || '[]'),
    
    init: function() {
      var self = this;
      
      // Measure performance on load
      window.addEventListener('load', function() {
        setTimeout(function() {
          self.measure();
        }, 100);
      });
      
      // Setup UI
      this.setupUI();
      
      // Log to console
      this.logToConsole();
    },
    
    measure: function() {
      if (!window.performance || !window.performance.timing) {
        console.warn('Performance API not available');
        return null;
      }
      
      var timing = window.performance.timing;
      var navigation = window.performance.navigation;
      
      this.currentTest = {
        version: this.version,
        timestamp: new Date().toISOString(),
        url: window.location.href,
        userAgent: navigator.userAgent.split(' ').pop(),
        metrics: {
          ttfb: timing.responseStart - timing.navigationStart,
          domInteractive: timing.domInteractive - timing.navigationStart,
          domContentLoaded: timing.domContentLoadedEventEnd - timing.navigationStart,
          domComplete: timing.domComplete - timing.navigationStart,
          pageLoad: timing.loadEventEnd - timing.navigationStart,
          dnsLookup: timing.domainLookupEnd - timing.domainLookupStart,
          tcpConnection: timing.connectEnd - timing.connectStart,
          serverResponse: timing.responseEnd - timing.requestStart
        },
        navigation: {
          type: navigation.type === 0 ? 'navigate' : navigation.type === 1 ? 'reload' : 'back_forward',
          redirectCount: navigation.redirectCount
        },
        resources: this.getResourceMetrics()
      };
      
      // Save to history
      this.tests.push(this.currentTest);
      if (this.tests.length > 20) {
        this.tests.shift(); // Keep only last 20 tests
      }
      localStorage.setItem('kb-perf-tests-baseline', JSON.stringify(this.tests));
      
      // Update dashboard
      this.updateDashboard();
      
      return this.currentTest;
    },
    
    getResourceMetrics: function() {
      if (!window.performance.getEntriesByType) return { count: 0, slowResources: [] };
      
      var resources = window.performance.getEntriesByType('resource');
      var slowResources = resources.filter(function(r) { return r.duration > 100; });
      
      return {
        count: resources.length,
        slowCount: slowResources.length,
        slowResources: slowResources.slice(0, 5).map(function(r) {
          return {
            name: r.name.split('/').pop().substring(0, 30),
            duration: Math.round(r.duration)
          };
        })
      };
    },
    
    getRating: function(metric, value) {
      var thresholds = {
        ttfb: { excellent: 200, good: 600, ok: 1000 },
        domInteractive: { excellent: 800, good: 1500, ok: 2500 },
        domContentLoaded: { excellent: 1000, good: 1800, ok: 3000 },
        domComplete: { excellent: 1500, good: 2500, ok: 4000 },
        pageLoad: { excellent: 2000, good: 3000, ok: 5000 }
      };
      
      var t = thresholds[metric] || thresholds.pageLoad;
      
      if (value < t.excellent) return 'excellent';
      if (value < t.good) return 'good';
      if (value < t.ok) return 'ok';
      return 'poor';
    },
    
    updateDashboard: function() {
      var metricsContainer = document.getElementById('kb-perf-metrics');
      var summaryContainer = document.getElementById('kb-perf-summary');
      
      if (!metricsContainer || !summaryContainer || !this.currentTest) return;
      
      var metrics = this.currentTest.metrics;
      var html = '';
      
      // Main metrics
      var mainMetrics = [
        { key: 'ttfb', label: 'TTFB', suffix: 'ms' },
        { key: 'domInteractive', label: 'DOM Interactive', suffix: 'ms' },
        { key: 'domContentLoaded', label: 'DOM Content Loaded', suffix: 'ms' },
        { key: 'domComplete', label: 'DOM Complete', suffix: 'ms' },
        { key: 'pageLoad', label: 'Page Load', suffix: 'ms' }
      ];
      
      mainMetrics.forEach(function(m) {
        var value = metrics[m.key];
        var rating = this.getRating(m.key, value);
        html += '<div class="metric">';
        html += '<span class="metric-name">' + m.label + ':</span>';
        html += '<span class="metric-value ' + rating + '">' + value + m.suffix + '</span>';
        html += '</div>';
      }.bind(this));
      
      // Resource count
      if (this.currentTest.resources) {
        html += '<div class="metric">';
        html += '<span class="metric-name">Resources:</span>';
        html += '<span class="metric-value">' + this.currentTest.resources.count + '</span>';
        html += '</div>';
        
        if (this.currentTest.resources.slowCount > 0) {
          html += '<div class="metric">';
          html += '<span class="metric-name">Slow Resources:</span>';
          html += '<span class="metric-value ok">' + this.currentTest.resources.slowCount + '</span>';
          html += '</div>';
        }
      }
      
      metricsContainer.innerHTML = html;
      
      // Summary
      var pageLoad = metrics.pageLoad;
      var score, emoji;
      if (pageLoad < 2000) {
        score = 'Excellent';
        emoji = 'ðŸš€';
      } else if (pageLoad < 3000) {
        score = 'Good';
        emoji = 'âœ…';
      } else if (pageLoad < 5000) {
        score = 'Fair';
        emoji = 'âš ï¸';
      } else {
        score = 'Poor';
        emoji = 'âŒ';
      }
      
      summaryContainer.innerHTML = emoji + ' ' + score + ' (' + pageLoad + 'ms)';
    },
    
    setupUI: function() {
      var self = this;
      var toggle = document.getElementById('kb-perf-toggle');
      var dashboard = document.getElementById('kb-perf-dashboard');
      var closeBtn = document.getElementById('kb-perf-close');
      var exportBtn = document.getElementById('kb-perf-export');
      var reloadBtn = document.getElementById('kb-perf-reload');
      
      if (toggle) {
        toggle.addEventListener('click', function() {
          if (dashboard.style.display === 'none' || !dashboard.style.display) {
            dashboard.style.display = 'block';
            toggle.style.display = 'none';
          }
        });
      }
      
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          dashboard.style.display = 'none';
          toggle.style.display = 'block';
        });
      }
      
      if (exportBtn) {
        exportBtn.addEventListener('click', function() {
          self.exportResults();
        });
      }
      
      if (reloadBtn) {
        reloadBtn.addEventListener('click', function() {
          location.reload();
        });
      }
    },
    
    exportResults: function() {
      var data = {
        version: this.version,
        currentTest: this.currentTest,
        allTests: this.tests,
        summary: this.getSummary()
      };
      
      var json = JSON.stringify(data, null, 2);
      
      // Copy to clipboard
      if (navigator.clipboard) {
        navigator.clipboard.writeText(json).then(function() {
          alert('âœ… BASELINE performance data copied to clipboard!\n\nSave this for comparison with optimized versions.');
        }).catch(function() {
          prompt('Copy this BASELINE data:', json);
        });
      } else {
        prompt('Copy this BASELINE data:', json);
      }
      
      // Also log to console
      console.log('%cðŸ“Š BASELINE Performance Test Results', 'font-size: 16px; font-weight: bold; color: #4CAF50; background: #f0f0f0; padding: 10px;');
      console.log(data);
    },
    
    getSummary: function() {
      if (this.tests.length === 0) return null;
      
      var metrics = ['ttfb', 'domInteractive', 'domContentLoaded', 'domComplete', 'pageLoad'];
      var summary = {};
      
      metrics.forEach(function(metric) {
        var values = this.tests.map(function(test) {
          return test.metrics[metric];
        });
        
        var sum = values.reduce(function(a, b) { return a + b; }, 0);
        var avg = Math.round(sum / values.length);
        var min = Math.min.apply(null, values);
        var max = Math.max.apply(null, values);
        
        summary[metric] = {
          average: avg,
          min: min,
          max: max,
          samples: values.length
        };
      }.bind(this));
      
      return summary;
    },
    
    logToConsole: function() {
      var self = this;
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (!self.currentTest) return;
          
          console.group('%câš¡ KB Widget Performance - BASELINE', 'font-size: 14px; font-weight: bold; color: #4CAF50');
          console.log('%cðŸ“Œ This is the BASELINE (original code) - No optimizations applied', 'color: #FF9800; font-weight: bold');
          console.log('');
          console.log('%cTest Results', 'font-size: 13px; font-weight: bold; color: #4CAF50');
          console.table(self.currentTest.metrics);
          
          if (self.tests.length > 1) {
            console.log('');
            console.log('%cHistory Summary (' + self.tests.length + ' tests)', 'font-size: 13px; font-weight: bold; color: #4CAF50');
            console.table(self.getSummary());
          }
          
          console.log('');
          console.log('%cðŸ“‹ To save baseline: Click "ðŸ“‹ Copy JSON" button or call window.kbPerfBaseline.exportResults()', 'color: #999');
          console.log('%cðŸ”„ To retest: Click "ðŸ”„ Retest" button or refresh page (Ctrl+Shift+R)', 'color: #999');
          console.groupEnd();
        }, 200);
      });
    }
  };
  
  // Initialize
  PerfMonitor.init();
  
  // Make available globally
  window.kbPerfBaseline = PerfMonitor;
  
})();
</script>
